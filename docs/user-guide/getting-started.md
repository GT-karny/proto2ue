# セットアップと初期設定

`proto2ue` を使用するための環境構築と、`protoc` プラグインが正しく呼び出せるかを確認する手順をまとめています。Unreal Engine プロジェクトへの統合ガイドは今後拡充予定ですが、ここで紹介するステップを完了すればヘッダー／ソースのスケルトン生成と基本的な検証を行えます。

## 必要なツール

| ツール | 推奨バージョン | 備考 |
| ------ | -------------- | ---- |
| Python | 3.11 以上 | 仮想環境の利用を推奨 |
| protoc | 3.21 以上 | `protoc --version` で確認可能 |
| pip    | 最新版        | `python -m pip install --upgrade pip` |

テストや動作確認には以下の Python パッケージが必要です。

```bash
pip install protobuf pytest
```

## 1. リポジトリの取得

```bash
git clone https://github.com/your-org/proto2ue.git
cd proto2ue
```

社内ミラーを利用する場合は URL を読み替えてください。

## 2. 仮想環境の作成と依存関係のインストール

```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install --upgrade pip
pip install protobuf pytest
```

依存パッケージは現段階では最小限に留めています。テンプレートエンジン等を導入する際は改めて `requirements` ファイルを提供します。

## 3. protoc の動作確認

`protoc` が正しくインストールされているかを確認します。

```bash
protoc --version
```

想定バージョンより古い場合は、[Protocol Buffers の公式配布ページ](https://github.com/protocolbuffers/protobuf/releases) からバイナリを入れ替えてください。

## 4. プラグインの疎通確認とコード生成

`proto2ue` には `proto2ue.codegen.DefaultTemplateRenderer` が同梱されており、`protoc` から呼び出すと UE 向けのヘッダー／ソースが生成されます。以下の手順で疎通と生成結果を確認してください。

1. 任意のディレクトリにサンプルの proto ファイル (`sample.proto`) を用意します。

   ```proto
   syntax = "proto2";

   package quickstart;

   message PlayerProfile {
     required string id = 1;
     optional uint32 level = 2;
     repeated string tags = 3;
   }
   ```

2. `proto2ue` リポジトリのルートで以下のコマンドを実行し、`protoc` から Python モジュールを参照できるようにします。生成したラッパースクリプトは任意の場所に配置して構いません。

   ```bash
   export PYTHONPATH="$(pwd)/src:${PYTHONPATH}"

   cat <<'SCRIPT' > ./protoc-gen-proto2ue
   #!/usr/bin/env bash
   PYTHONPATH="${PYTHONPATH}" python -m proto2ue.plugin "$@"
   SCRIPT
   chmod +x ./protoc-gen-proto2ue

   protoc \
     --plugin=protoc-gen-proto2ue="$(pwd)/protoc-gen-proto2ue" \
     --proto2ue_out=./Generated \
     --proto_path=. \
     sample.proto
   ```

   `--proto2ue_out` に指定したディレクトリに `<proto 名>.proto2ue.h` と `<proto 名>.proto2ue.cpp` が生成されれば成功です。エラーが表示される場合は、`PYTHONPATH` や `protobuf` パッケージのインストール状況、proto の依存解決を確認してください。

3. 生成されたヘッダーには `USTRUCT` / `UENUM` 宣言と `UPROPERTY` メタデータが含まれます。例えば `sample.proto` からは次のようなスケルトンが得られます。

   ```cpp
   #pragma once

   // Generated by proto2ue. Source: sample.proto

   #include "CoreMinimal.h"
   #include "sample.proto2ue.generated.h"

   namespace quickstart {

   USTRUCT(BlueprintType)
   struct FPerson {
       GENERATED_BODY()
       UPROPERTY(BlueprintReadWrite)
       FString name{};
       UPROPERTY(BlueprintReadWrite)
       TOptional<FString> email{};
   };

   USTRUCT(BlueprintType)
   struct FAddressBook {
       GENERATED_BODY()
       UPROPERTY(BlueprintReadWrite)
       TArray<FPerson> people{};
   };

   }  // namespace quickstart
   ```

   対応する `.cpp` には将来的なモジュール登録に利用する `proto2ue::RegisterGeneratedTypes_*` 関数のスタブが出力されます。

4. さらに詳細を確認したい場合は、`tests/test_descriptor_loader.py` や `tests/test_type_mapper.py` を参考に Python スクリプトを作成し、中間表現やマッピング結果をログに出力できます。

## 5. 次のステップ

- [基本ワークフロー・チュートリアル](tutorials/basic-workflow.md) で、`TypeMapper` が生成する Unreal Engine 向けの型名・フィールド情報を詳しく確認できます。
- UE プロジェクト向けのテンプレートは今後提供予定です。それまではチュートリアル内のコードスニペットを参考に手動でプロジェクトへ組み込むことを想定しています。

不明点がある場合は Issue でご質問ください。ドキュメントは機能追加のタイミングで順次更新します。

## Blueprint 向け optional ラッパー構造体

`proto2ue` のコード生成では、`optional` フィールドをそのまま `TOptional` で表現するのではなく、Blueprint で安全に扱えるようラッパー構造体
（`FProtoOptional<Type>`）を自動的に合成します。各構造体は次のメンバーを備えています。

- `bool bIsSet` — フィールドが設定済みかどうかを示すフラグ。デフォルト値は `false` です。
- `Type Value` — 実際の値を格納します。`Type` には `TypeMapper` が算出した UE 側の型名が入ります（例: `int32`, `FString`, `FPersonAttributes`）。

同じ基底型に対して生成されるラッパーは 1 つのみで、ヘッダーファイルでは `USTRUCT(BlueprintType)` としてエクスポートされます。そのため Blueprint
からも `bIsSet` と `Value` を直接参照・更新できます。フィールド宣言側では、従来の `TOptional<Type>` の代わりに合成された構造体を使用してください。

カスタムの接頭辞を利用したい場合は、`TypeMapper(optional_wrapper="FMyOptional")` のように初期化することで `FMyOptional<Type>` という命名に切り替えられます。
生成されるメンバー名（`bIsSet` / `Value`）は固定であり、Blueprint 上でのバインディングやシリアライズ処理もこのレイアウトを前提とします。
