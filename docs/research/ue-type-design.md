# UE 側型設計とヘルパー API 要件 (2024-06 更新)

`TypeMapper`・`DefaultTemplateRenderer`・`ConvertersTemplate` の実装内容を反映した最新の設計ノートです。proto2 のメッセージ／列挙をどのように UE の型へマッピングし、Optional や Blueprint サポートを扱うかを記録します。

## 命名規約

- メッセージは `F` プレフィックス + パッケージ相対名を PascalCase 化した名前 (`FPerson`, `FExampleMeta`)。
- 列挙は `E` プレフィックス (`EColor`, `EPersonMood`)。値は proto の名前をそのまま使用。
- Optional ラッパーは `FProtoOptional` + `<ファイル識別子><基底型名>` (`FProtoOptionalExamplePersonFString`)。ファイル識別子は proto ファイル名から生成され、衝突を避ける。
- 名前衝突時は `Proto` を挿入 (`FProtoPerson` / `EProtoPerson`)。UE 側の予約語 (`FVector` など) は自動的に避ける。
- 生成コードの名前空間は `UE_NAMESPACE_BEGIN(<package>)` / `UE_NAMESPACE_END(<package>)` でラップし、追加の内部ヘルパー (`Proto2UE::Converters`) は別名前空間で定義。

## リフレクション属性とメタデータ

- メッセージ (`USTRUCT`) と列挙 (`UENUM`) は `BlueprintType` をデフォルトで付与。`unreal = { blueprint_type: false }` オプションが指定された場合は除外。
- フィールド (`UPROPERTY`) は既定で `BlueprintReadWrite`。`unreal.field = { blueprint_read_only: true }` で `BlueprintReadOnly` に切り替え。
- `unreal` オプションの `specifiers`, `meta`, `category` を解析し、`UPROPERTY(...)` の引数と `meta=(...)` に反映。
- Optional ラッパーの `Value` プロパティは、基底型が Blueprint 非公開の場合 (`blueprint_type: false`) に `BlueprintReadOnly`/`BlueprintType` を無効化。

## フィールド型マッピング

`TypeMapper._SCALAR_MAPPING` に基づく標準マッピング:

| Proto 型 | UE 型 |
| --- | --- |
| `double` | `double` |
| `float` | `float` |
| `int32` / `sint32` / `sfixed32` | `int32` |
| `uint32` / `fixed32` | `uint32` |
| `int64` / `sint64` / `sfixed64` | `int64` |
| `uint64` / `fixed64` | `uint64` |
| `bool` | `bool` |
| `string` | `FString` |
| `bytes` | `TArray<uint8>` |

その他:

- メッセージ／列挙フィールドはマッピング済みの `F`/`E` 型を参照。
- `repeated` は `TArray<要素型>`、`map<K,V>` は `TMap<K, V>` に展開。
- `optional` および `oneof` メンバーは Optional ラッパーに包まれ、`bIsSet` と `Value` を持つ構造体になる。

## Optional / Oneof の扱い

- Optional ラッパーは proto ファイル内で一意に生成され、複数フィールドで共有。`bIsSet` が `false` の場合 `Value` は既定値。
- `oneof` の構造体はまだ C++ に出力していないが、`UEOneofWrapper` として中間表現に保持しており、コメントで `// oneof ...` を出力。今後のテンプレート更新で専用の wrapper struct を生成可能。
- proto2 の `required` は追加ラッパーを生成せず、そのままフィールドとして出力。

## コード生成規約

- `.proto2ue.h` は `#pragma once` + 生成警告コメント + `#include "CoreMinimal.h"` + 自動生成ヘッダー (`.generated.h`) を含む。
- `.proto2ue.cpp` は対応するヘッダーをインクルードし、`Proto2UE::RegisterGeneratedTypes()` スタブを配置。今後コンバーターやリフレクション登録コードを拡張予定。
- Optional ラッパーはメッセージの直前に生成され、同一型の循環参照を回避するために依存順序を調整して出力。

## 変換ヘルパー API (`ConvertersTemplate`)

- 名前空間: `namespace Proto2UE::Converters`。
- 生成関数:
  - `void ToProto(const FPerson& Source, example::Person& Out, FConversionContext* Context = nullptr);`
  - `bool FromProto(const example::Person& Source, FPerson& Out, FConversionContext* Context = nullptr);`
- `FConversionContext` は `TArray<FConversionError>` を保持し、`AddError` / `HasErrors` / `GetErrors` を提供。
- Blueprint 用ラッパー: `UProto2UEBlueprintLibrary` に `<Name>ToProtoBytes` / `<Name>FromProtoBytes` を生成し、`Error` を `FString` で返却。
- Python 版 (`PythonConvertersRuntime`) は単体テストでラウンドトリップ検証に利用。

## ドキュメント化すべきルール

1. Optional ラッパーの命名は proto ファイルごとに安定しており、他ファイルと共有しない。ヘッダーの include 順序を変更する際は依存関係に注意。
2. `UE_NAMESPACE_BEGIN/END` を利用するため、UE5.1 以降を対象とする (`UE_NAMESPACE_BEGIN` は 5.1+ の機能)。
3. 生成コードを手動編集しないよう、ヘッダーとソースの先頭に「Generated by proto2ue」コメントを入れている。差分生成ではコメントを比較して再生成可否を判断する。

## 今後の検討事項

- `oneof` 専用ラッパー生成と Blueprint UI での選択肢表示 (`FInstancedStruct` 等)。
- Blueprint から扱いやすい 64bit 数値ラッパー (`FProtoInt64`, `FProtoUInt64`) の導入。現在は直接 `int64` / `uint64` を露出。
- 生成コードの差分書き込み (`manifest.json`) と `clang-format` の自動適用。
- `ConvertersTemplate` と `DefaultTemplateRenderer` を統合し、`generate_code` から一括で `.converters.*` を出力するオプション追加。
